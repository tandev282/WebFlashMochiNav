<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ESP32 License Activator</title>
<style>
  :root{
    --ok:#0a7a00;
    --err:#b00020;
    --muted:#777;
  }
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;max-width:780px;margin:32px auto;padding:0 16px}
  .header{
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px
  }
  h1{font-size:22px;margin:0}
  h1.ok{color:var(--ok)}
  h1.err{color:var(--err)}
  .badge{
    font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #ddd
  }
  .badge.ok{background:#e8f5e9;border-color:#c8e6c9;color:var(--ok)}
  .badge.err{background:#ffebee;border-color:#ffcdd2;color:var(--err)}
  .badge.muted{background:#f3f3f3;color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  input,button{font-size:14px;padding:10px 12px;border-radius:10px;border:1px solid #ddd}
  button{cursor:pointer}
  #log{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;border:1px solid #eee;border-radius:10px;padding:12px;min-height:140px;background:#fafafa}
  .ok{color:var(--ok)} .err{color:var(--err)}
  small code{user-select:all}
</style>
</head>
<body>
  <div class="header">
    <h1 id="title" class="err">ESP32 License Activator</h1>
    <span id="statusBadge" class="badge muted">Chưa kết nối</span>
  </div>

  <div class="row">
    <button id="btnConnect">Kết nối ESP32</button>
    <button id="btnGetDid" disabled>Lấy Device ID</button>
  </div>

  <div class="row">
    <input id="inpDid" placeholder="Device ID (sẽ hiển thị sau khi bấm Get/HELLO)" style="flex:1" readonly />
    <input id="inpKey" placeholder="Nhập key: MOCHI-XXXXX hoặc key trong Firebase" style="flex:1" />
  </div>

  <div class="row">
    <button id="btnActivate" disabled>Kích hoạt</button>
    <button id="btnReboot" disabled>Reboot</button>
  </div>

  <div class="row">
    <small>Endpoint ký: <code>https://license-signer.tandev.workers.dev/sign</code></small>
  </div>

  <div id="log"></div>

<script>
const WORKER_URL = "https://license-signer.tandev.workers.dev/sign";
let port, reader, writer;

// --- tiện ích UI ---
const $ = s => document.querySelector(s);
const escapeHtml = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const log = (m, cls="") => { const el=$("#log"); const t=new Date().toLocaleTimeString(); el.innerHTML += `<div class="${cls}">[${t}] ${escapeHtml(m)}</div>`; el.scrollTop = el.scrollHeight; };

function setStatusUI(isSigned, reason="") {
  const title = $("#title");
  const badge = $("#statusBadge");
  if (isSigned) {
    title.classList.remove("err"); title.classList.add("ok");
    badge.className = "badge ok";
    badge.textContent = "ĐÃ KÝ • Full features";
  } else {
    title.classList.remove("ok"); title.classList.add("err");
    badge.className = "badge err";
    badge.textContent = reason ? `CHƯA KÝ • ${reason}` : "CHƯA KÝ";
  }
}

// --- hàng đợi chờ dòng phù hợp ---
const waiters = [];
function notifyLine(line){
  // cập nhật UI nếu là STATUS hoặc DID
  if (line.startsWith("STATUS:")) {
    if (/SIGNED/i.test(line)) setStatusUI(true);
    else {
      const m = line.match(/^STATUS:\s*UNSIGNED\s*\((.+)\)/i);
      setStatusUI(false, m ? m[1] : "");
    }
  }
  if (line.startsWith("DID:")) {
    const did = line.replace(/^DID:\s*/i,"").trim();
    $("#inpDid").value = did.toUpperCase();
  }

  for (let i = waiters.length - 1; i >= 0; i--) {
    const { re, resolve } = waiters[i];
    if (re.test(line)) { waiters.splice(i,1); resolve(line); }
  }
}
function waitForLine(re, timeoutMs=5000){
  return new Promise((resolve, reject) => {
    const timer = setTimeout(()=>{
      const idx = waiters.findIndex(w => w.resolve === resolve);
      if (idx >= 0) waiters.splice(idx,1);
      reject(new Error("timeout waiting for line: "+re));
    }, timeoutMs);
    waiters.push({ re, resolve: (line)=>{ clearTimeout(timer); resolve(line); } });
  });
}

// --- read pump: đọc nền, log & phát sự kiện dòng ---
let pumpRunning = false;
async function startReadPump(){
  if (pumpRunning) return;
  pumpRunning = true;
  const dec = new TextDecoder();
  let buf = "";
  try{
    while (true){
      const { value, done } = await reader.read();
      if (done) break;
      if (!value) continue;
      buf += dec.decode(value);
      let i;
      while ((i = buf.indexOf("\n")) >= 0) {
        let line = buf.slice(0,i).replace(/\r/g,"").trim();
        buf = buf.slice(i+1);
        if (!line) continue;
        log("<< " + line);
        notifyLine(line);
      }
    }
  } catch(e) {
    // ignore
  } finally { pumpRunning = false; }
}

// --- serial open / write ---
async function openSerial(){
  if(!("serial" in navigator)){ alert("Trình duyệt không hỗ trợ Web Serial."); return; }
  port = await navigator.serial.requestPort();
  await port.open({ baudRate: 115200 });

  // ESP32-S3 USB-CDC thường cần DTR=true
  try { await port.setSignals?.({ dataTerminalReady: true, requestToSend: false }); } catch {}

  reader = port.readable.getReader();
  writer = port.writable.getWriter();
  startReadPump();

  log("Đã kết nối serial.");
  $("#btnGetDid").disabled = false;
  $("#btnActivate").disabled = false;
  $("#btnReboot").disabled = false;

  // Ngay khi kết nối: hỏi HELLO để lấy STATUS + DID cho UI
  await sendLine("HELLO");
  // chờ cả STATUS và DID (không chặn UI nếu timeout)
  waitForLine(/^STATUS:/i, 1500).catch(()=>{});
  waitForLine(/^DID:/i, 1500).catch(()=>{});
}

async function sendLine(line){
  const enc = new TextEncoder();
  await writer.write(enc.encode(line + "\r\n")); // CRLF
  log(">> " + line);
}

// --- nghiệp vụ ---
async function getDid(){
  const MAX_TRY = 2;
  for (let attempt=1; attempt<=MAX_TRY; attempt++){
    await sendLine("GETDID");
    try{
      const didLine = await waitForLine(/^DID:\s*[0-9A-F]{2}(?::[0-9A-F]{2}){5}$/i, 2000);
      const m = didLine.match(/^DID:\s*([0-9A-F]{2}(?::[0-9A-F]{2}){5})$/i);
      const did = m[1].toUpperCase();
      $("#inpDid").value = did;
      log("Device ID: " + did, "ok");
      return did;
    }catch(e){
      log(`Không thấy DID (lần ${attempt})`, "err");
    }
  }
  throw new Error("Không nhận được DID từ ESP32");
}

function showPayload(license){
  try{
    const payloadB64 = license.split(".")[0];
    const json = JSON.parse(atob(payloadB64));
    log("Payload: " + JSON.stringify(json,null,2), "ok");
  }catch(e){ log("Decode payload lỗi: " + e, "err"); }
}

async function activate(){
  const deviceId = $("#inpDid").value.trim();
  const activationKey = $("#inpKey").value.trim();
  if(!deviceId){ alert("Hãy bấm 'Lấy Device ID' hoặc kết nối để lấy DID trước."); return; }
  if(!activationKey){ alert("Nhập activation key!"); return; }

  log("Gọi server ký...");
  const res = await fetch(WORKER_URL, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ deviceId, activationKey })
  });
  const js = await res.json().catch(()=> ({}));
  if(!res.ok){ log("Sign lỗi: " + JSON.stringify(js), "err"); return; }

  const license = js.license;
  log("Nhận license OK.");
  showPayload(license);

  await sendLine("LIC:" + license);

  // chờ [OK] hoặc [ERR:...]; đồng thời sẽ có dòng SIGNED/UNSIGNED để UI cập nhật
  try {
    const ok = await waitForLine(/^\[(OK|ERR:.*)\]$/i, 5000);
    if (/^\[OK\]$/i.test(ok)) {
      log("ESP32 xác nhận license.", "ok");
      setStatusUI(true);
    } else {
      log("ESP32 từ chối license: " + ok, "err");
      // sau ERR sẽ có dòng UNSIGNED (...) → UI sẽ tự cập nhật qua notifyLine
    }
  } catch {
    log("Không nhận được phản hồi từ ESP32 sau khi gửi license.", "err");
  }
}

async function reboot(){
  await sendLine("REBOOT");
}

$("#btnConnect").onclick = () => openSerial().catch(e=>log(String(e),"err"));
$("#btnGetDid").onclick   = () => getDid().catch(e=>log(String(e),"err"));
$("#btnActivate").onclick = () => activate().catch(e=>log(String(e),"err"));
$("#btnReboot").onclick   = () => reboot().catch(e=>log(String(e),"err"));

window.addEventListener("beforeunload", async ()=>{
  try{ await reader?.releaseLock(); await writer?.releaseLock(); await port?.close(); }catch{}
  setStatusUI(false,"Chưa kết nối");
});
</script>
</body>
</html>
