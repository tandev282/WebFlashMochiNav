<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Update Firmware | TanDev</title>

  <!-- esp-web-tools -->
  <script type="module" src="https://unpkg.com/esp-web-tools@10.0.0/dist/web/install-button.js?module"></script>

  <link rel="stylesheet" href="../style.css" />
  <style>
    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 1.5rem;
    }

    h1 {
      margin-bottom: .75rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .muted {
      color: var(--text-secondary);
    }

    .controls {
      margin-top: 1.25rem;
      display: flex;
      gap: .75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: #fff;
      padding: .85rem 1.25rem;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: .85rem 1.25rem;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      font-weight: 700;
      cursor: pointer;
    }

    .result {
      margin-top: 1rem;
      padding: .75rem 1rem;
      border-radius: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      white-space: pre-wrap;
    }

    .hidden {
      display: none !important;
    }

    .progress {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin-top: .5rem;
    }

    .progress>span {
      display: block;
      width: 0%;
      height: 100%;
      background: var(--accent-primary);
      transition: width .3s;
    }

    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.4;
      max-height: 260px;
      overflow: auto;
      margin-top: .5rem;
    }

    .ok {
      color: #22c55e;
    }

    .warn {
      color: #f59e0b;
    }

    .err {
      color: #ef4444;
    }

    /* ===== phi√™n b·∫£n d·∫°ng h√†ng c√≥ n√∫t c√†i ƒë·∫∑t ===== */
    .version-list {
      display: grid;
      gap: .5rem;
    }

    .version-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .8rem 1rem;
      border: 1px dashed var(--border-color);
      background: var(--bg-tertiary);
      border-radius: 12px;
    }

    .version-name {
      font-weight: 700;
    }

    .inline-install {
      background: var(--gradient-primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: .55rem .9rem;
      cursor: pointer;
      font-weight: 700;
    }

    .versions-wrap {
      margin-top: .5rem;
      display: flex;
      flex-direction: column;
      gap: .6rem;
    }

    .ver-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: .9rem 1rem;
      transition: all .3s ease;
      position: relative;
      overflow: hidden;
    }

    .ver-card::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      height: 3px;
      width: 100%;
      background: var(--gradient-primary);
      transform: scaleX(0);
      transition: transform .3s ease;
    }

    .ver-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-md);
    }

    .ver-card:hover::before {
      transform: scaleX(1);
    }

    .ver-name {
      font-weight: 700;
      letter-spacing: .2px;
    }

    /* N√∫t c√†i ƒë·∫∑t nh·ªè g·ªçn nh∆∞ng v·∫´n ‚Äúƒë·∫ßm‚Äù */
    .ver-install-btn {
      border: none;
      border-radius: 10px;
      padding: .55rem .95rem;
      font-weight: 700;
      cursor: pointer;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      transition: all .25s ease;
    }

    .ver-install-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      border-color: var(--accent-primary);
      color: #fff;
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="card">
      <h1>Tr√¨nh c·∫≠p nh·∫≠t firmware</h1>
      <p class="muted">K·∫øt n·ªëi thi·∫øt b·ªã ESP32-S3, nh·∫≠n di·ªán lo·∫°i chip v√† phi√™n b·∫£n hi·ªán t·∫°i. Sau ƒë√≥ ch·ªçn firmware t·ª´
        GitHub.</p>

      <div class="controls">
        <button id="btnConnect" class="btn-primary">üîå K·∫øt n·ªëi</button>
        <button id="btnCheckUpdate" class="btn-secondary hidden">üîç Ki·ªÉm tra c·∫≠p nh·∫≠t</button>
        <button id="btnFactoryReset" class="btn-secondary hidden">‚ôªÔ∏è Kh√¥i ph·ª•c c√†i ƒë·∫∑t g·ªëc</button>
      </div>

      <div id="deviceInfo" class="result">Ch∆∞a k·∫øt n·ªëi.</div>

      <div id="versions" class="result hidden">
        <!-- s·∫Ω render c√°c .version-item v√†o ƒë√¢y -->
        <div class="version-list" id="versionList"></div>
      </div>

      <div class="progress"><span id="bar"></span></div>
      <div id="log" class="log hidden"></div>

      <!-- n√∫t t·ªïng c·∫≠p nh·∫≠t kh√¥ng c√≤n c·∫ßn; ƒë·ªÉ hidden ƒë·ªÅ ph√≤ng d√πng l·∫°i -->
      <button id="btnUpdate" class="btn-primary hidden">‚ö° C·∫≠p nh·∫≠t</button>

      <div class="center" style="margin-top:.75rem">
        <esp-web-install-button id="installBtn" class="hidden"></esp-web-install-button>
      </div>
    </div>
  </main>

  <script>
    const $ = (s) => document.querySelector(s);
    const btnConnect = $("#btnConnect");
    const btnCheckUpdate = $("#btnCheckUpdate");
    const btnFactoryReset = $("#btnFactoryReset");
    const installBtn = $("#installBtn");
    const deviceInfo = $("#deviceInfo");
    const versionsBox = $("#versions");
    const versionList = $("#versionList");
    const logBox = $("#log");
    const bar = document.querySelector(".progress > span");


    async function listVersions() {
      const releases = await fetchReleases();
      let items = [];

      releases.forEach(r => {
        r.assets?.forEach(a => {
          if (chipType === "zero" && a.name.endsWith(".json") && a.name.includes("zero")) {
            const ver = (a.name.match(/xiaozhi-zero-(.+)\.json/) || [])[1];
            if (ver) items.push({ version: ver, url: a.browser_download_url });
          }
          if (chipType === "mini" && a.name.endsWith(".json") && a.name.includes("mini")) {
            const ver = (a.name.match(/xiaozhi-mini-(.+)\.json/) || [])[1];
            if (ver) items.push({ version: ver, url: a.browser_download_url });
          }
        });
      });

      if (items.length === 0) {
        versionsDiv.textContent = "Kh√¥ng t√¨m th·∫•y b·∫£n firmware cho lo·∫°i chip n√†y.";
        versionsDiv.classList.remove("hidden");
        return;
      }

      // Build compact list with hover
      versionsDiv.innerHTML = `
      <div class="versions-wrap">
        ${items.map(i => `
          <div class="ver-card" data-manifest="${i.url}">
            <span class="ver-name">v${i.version}</span>
            <button class="ver-install-btn">C√†i ƒë·∫∑t</button>
          </div>
        `).join("")}
      </div>
    `;
      versionsDiv.classList.remove("hidden");
      btnUpdate.classList.add("hidden");          // kh√¥ng d√πng n√∫t Update t·ªïng n·ªØa
      installBtn.classList.add("hidden");         // ·∫©n ƒë·∫øn khi b·∫•m ‚ÄúC√†i ƒë·∫∑t‚Äù

      // Delegate click: b·∫•m v√†o n√∫t ‚ÄúC√†i ƒë·∫∑t‚Äù c·ªßa t·ª´ng d√≤ng
      versionsDiv.querySelectorAll(".ver-install-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const card = e.currentTarget.closest(".ver-card");
          const manifestUrl = card?.dataset.manifest;
          if (!manifestUrl) return;

          installBtn.manifest = manifestUrl;
          installBtn.setAttribute("erase-first", "");
          installBtn.classList.remove("hidden");
          installBtn.click();
        });
      });
    }

    let chipType = null; // "zero" | "mini"
    let lastLog = "";

    // ===== UI helpers =====
    function setProgress(p) { bar.style.width = (p || 0) + "%"; }
    function setInfo(msg, kind = "") { deviceInfo.textContent = msg; deviceInfo.className = "result " + (kind || ""); }
    function showLog(show) { logBox.classList.toggle("hidden", !show); }
    function appendLog(txt) { lastLog += txt; logBox.textContent = lastLog; logBox.scrollTop = logBox.scrollHeight; }

    // ===== Detect helpers =====
    function parseDeviceInfo(log) {
      const verMatch = log.match(/App version:\s+([^\n]+)/i);
      const version = verMatch ? verMatch[1].trim() : "Kh√¥ng r√µ";
      const has2MB = /esp_psram:\s+Found\s+2MB/i.test(log);
      const board = has2MB ? "ESP32-S3 Zero (2MB PSRAM)" : "ESP32-S3 Super Mini (no PSRAM)";
      chipType = has2MB ? "zero" : "mini";
      return { version, board };
    }

    // reset nh·∫π: ch·ªâ EN (DTR), kh√¥ng k√©o IO0 (RTS)
    async function pulseResetEN(port) {
      try {
        await port.setSignals({ dataTerminalReady: false, requestToSend: false });
        await new Promise(r => setTimeout(r, 100));
        await port.setSignals({ dataTerminalReady: true, requestToSend: false });
        await new Promise(r => setTimeout(r, 120));
        await port.setSignals({ dataTerminalReady: false, requestToSend: false });
      } catch (e) { console.warn("pulseResetEN:", e); }
    }

    async function connectAndDetect() {
      if (!("serial" in navigator)) { setInfo("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Serial. H√£y d√πng Chrome/Edge.", "err"); return; }
      setProgress(5);
      lastLog = ""; logBox.textContent = ""; showLog(true);
      setInfo("Y√™u c·∫ßu quy·ªÅn truy c·∫≠p c·ªïng serial...");
      const port = await navigator.serial.requestPort({});
      await port.open({ baudRate: 115200 });
      setProgress(20);

      setInfo("ƒêang reset ƒë·ªÉ ƒë·ªçc log kh·ªüi ƒë·ªông...", "warn");
      await pulseResetEN(port);
      setProgress(35);

      const reader = port.readable.getReader();
      const decoder = new TextDecoder();
      const t0 = Date.now(); const timeoutMs = 3500;
      try {
        while (Date.now() - t0 < timeoutMs) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) appendLog(decoder.decode(value));
        }
      } finally { try { reader.releaseLock(); } catch (e) { } }

      const cutIdx = lastLog.indexOf("main_task: Calling app_main()");
      const bootLog = cutIdx > -1 ? lastLog.slice(0, cutIdx) : lastLog;

      const { version, board } = parseDeviceInfo(bootLog);
      setInfo(`Phi√™n b·∫£n hi·ªán t·∫°i: ${version}\nThi·∫øt b·ªã: ${board}`, "ok");

      try { await port.close(); } catch (e) { }

      btnConnect.textContent = "üîÑ K·∫øt n·ªëi l·∫°i";
      btnCheckUpdate.classList.remove("hidden");
      btnFactoryReset.classList.remove("hidden");
      setProgress(60);
    }

    // ===== GitHub releases -> danh s√°ch manifest theo tag (CORS-safe) =====
    async function fetchReleases() {
      const res = await fetch("https://api.github.com/repos/tandev282/xiaozhi-update/releases");
      if (!res.ok) throw new Error("GitHub API error: " + res.status);
      return res.json();
    }
    const normVer = v => (v || "").toString().trim().replace(/^v/i, "");
    function toItemsFromReleases(rels, chip) {
      const want = chip === "zero" ? "zero" : "mini";
      const items = [];
      for (const r of rels) {
        const v = normVer(r.tag_name || r.name || "");
        if (!v) continue;
        const json = `xiaozhi-${want}-${v}.json`;
        const url = `https://cdn.jsdelivr.net/gh/tandev282/xiaozhi-update@${v}/${json}`;
        items.push({ version: v, url, relDate: r.published_at || r.created_at || "" });
      }
      return items.sort(
        (a, b) => (new Date(b.relDate) - new Date(a.relDate)) ||
          b.version.localeCompare(a.version, undefined, { numeric: true, sensitivity: "base" })
      );
    }

    async function listVersions() {
      if (!chipType) { setInfo("Ch∆∞a x√°c ƒë·ªãnh lo·∫°i chip. H√£y K·∫øt n·ªëi tr∆∞·ªõc.", "warn"); return; }
      setProgress(70);
      versionsBox.classList.remove("hidden");
      versionList.innerHTML = "‚è≥ ƒêang t·∫£i danh s√°ch b·∫£n c·∫≠p nh·∫≠t t·ª´ GitHub...";

      try {
        const releases = await fetchReleases();
        const items = toItemsFromReleases(releases, chipType);
        if (!items.length) { versionList.textContent = "Kh√¥ng t√¨m th·∫•y b·∫£n firmware cho lo·∫°i chip n√†y."; return; }

        // render d·∫°ng H√ÄNG: t√™n phi√™n b·∫£n (tr√°i) + n√∫t C√†i ƒë·∫∑t (ph·∫£i)
        versionList.innerHTML = items.map(i => `
          <div class="version-item" data-url="${i.url}">
            <span class="version-name">v${i.version}</span>
            <button class="inline-install" data-url="${i.url}">C√†i ƒë·∫∑t</button>
          </div>
        `).join("");

        setProgress(85);
      } catch (e) {
        console.error(e);
        versionList.textContent = "‚ö†Ô∏è L·ªói khi t·∫£i release GitHub.";
      }
    }

    // Nh·∫•n n√∫t "C√†i ƒë·∫∑t" t·∫°i t·ª´ng d√≤ng ‚Üí flash b·∫£n t∆∞∆°ng ·ª©ng
    versionList.addEventListener("click", (ev) => {
      const btn = ev.target.closest(".inline-install");
      if (!btn) return;
      const manifestUrl = btn.dataset.url;
      if (!manifestUrl) return;

      // giao cho esp-web-tools
      installBtn.manifest = manifestUrl;
      installBtn.setAttribute("erase-first", "");
      installBtn.classList.remove("hidden");
      installBtn.click();
      setProgress(100);
    });

    // ===== Factory reset (placeholder) =====
    btnFactoryReset.addEventListener("click", () => {
      alert("Kh√¥i ph·ª•c c√†i ƒë·∫∑t g·ªëc: h√£y ch·ªçn phi√™n b·∫£n factory trong danh s√°ch v√† b·∫•m C√†i ƒë·∫∑t.");
    });

    // ===== Wire buttons =====
    btnConnect.addEventListener("click", connectAndDetect);
    btnCheckUpdate.addEventListener("click", listVersions);
  </script>
</body>

</html>